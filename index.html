<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J's Vault Stitcher | Archive Edition</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #1a1a1a;
            --accent-color: #000000;
            --gray-light: #f4f4f4;
            --border-color: #e0e0e0;
            --danger-color: #ff4757;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* 布局框架 */
        .sidebar {
            width: 340px;
            background: #fff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            background: #f9f9f9;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: #fff;
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: none; /* JS控制显示 */
        }

        .sidebar-content.active {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 控件样式 */
        h1 { font-size: 16px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        label { font-size: 12px; font-weight: 600; color: #666; display: block; margin-bottom: 5px; }

        .control-group {
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 10px;
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 5px;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background: #fff; color: #000; border: 1px solid #ccc; }
        button.danger { background: var(--danger-color); color: #fff; }

        input, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        /* 存档列表样式 */
        .archive-item {
            background: var(--gray-light);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .archive-item:hover { background: #e9e9e9; }
        .archive-meta { font-size: 10px; color: #888; }

        /* 预览区 */
        .main-area {
            flex: 1;
            padding: 40px;
            background: #f0f0f0;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #preview-container {
            background: #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 0; /* 贴合边框 */
            display: grid;
            width: 100%;
            max-width: 1200px;
        }

        /* 图片卡片 */
        .img-card {
            position: relative;
            background: #ddd;
            aspect-ratio: 1/1;
            overflow: hidden;
            cursor: pointer;
        }

        .img-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* 翻转背面 */
        .card-back {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #222;
            color: #fff;
            padding: 10px;
            box-sizing: border-box;
            transform: translateY(100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .img-card.flipped .card-back {
            transform: translateY(0);
        }

        .card-back textarea {
            background: transparent; border: none; color: #fff;
            width: 100%; height: 100%; resize: none; outline: none;
        }

        /* 序号 - 巨大化 */
        .badge {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(255,255,255,0.95);
            color: #000;
            font-weight: 800;
            padding: 5px 15px 5px 10px;
            border-bottom-right-radius: 15px;
            font-size: 28px; /* 加大 */
            z-index: 5;
            pointer-events: none;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .flip-btn {
            position: absolute; bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.6); color: #fff;
            width: 25px; height: 25px; border-radius: 50%;
            text-align: center; line-height: 25px; font-size: 12px;
            z-index: 6;
        }

        /* 选中态高亮 */
        .selected-border {
            outline: 4px solid var(--danger-color);
            outline-offset: -4px;
        }
    </style>
</head>
<body>

<!-- 侧边栏 -->
<div class="sidebar">
    <div class="tab-header">
        <div class="tab-btn active" onclick="switchTab('editor')">拼图编辑</div>
        <div class="tab-btn" onclick="switchTab('archive')">本地存档库</div>
    </div>

    <!-- 编辑器面板 -->
    <div id="tab-editor" class="sidebar-content active">
        <div class="control-group">
            <label>1. 导入资源</label>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
            <button onclick="document.getElementById('fileInput').click()">+ 选择图片 / 添加到当前</button>
            <div style="font-size:10px; color:#666; margin-top:5px; text-align:center;">
                当前：<span id="imgCount">0</span> 张
            </div>
        </div>

        <div class="control-group">
            <label>2. 布局设置</label>
            <div style="display:flex; gap:5px;">
                <select id="ratioSelect" onchange="renderGallery()" style="flex:2">
                    <option value="1/1">1:1 正方形</option>
                    <option value="3/4">3:4 竖屏</option>
                    <option value="4/3">4:3 横屏</option>
                    <option value="9/16">9:16 用</option>
                    <option value="16/9">16:9 横</option>
                    <option value="custom">自定义...</option>
                </select>
                <input type="number" id="colsInput" value="3" min="1" placeholder="列数" onchange="renderGallery()" style="flex:1">
            </div>
            <div id="customRatioBox" style="display:none; gap:5px;">
                <input type="number" id="cW" placeholder="W" value="16"> : <input type="number" id="cH" placeholder="H" value="9">
            </div>
        </div>

        <div class="control-group">
            <label>3. 序号与水印</label>
            <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                <input type="checkbox" id="showNumbers" checked onchange="renderGallery()" style="width:auto;"> 显示大序号
            </div>

            <label style="margin-top:10px;">防盗水印 (斜线)</label>
            <div style="display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="showWatermark" style="width:auto;" onchange="saveConfig()"> 开启
                <input type="range" id="wmOpacity" min="0" max="100" value="20" style="flex:1" onchange="saveConfig()">
                <span id="wmVal">20%</span>
            </div>
        </div>

        <div class="control-group">
            <label>4. 导出 (文件名将加密为 bengdai)</label>
            <input type="text" id="targetIndex" placeholder="输入序号导出单张(例: 1,3,5)" style="margin-bottom:5px;">
            <button class="secondary" onclick="downloadSingle()">下载指定序号图片 (原图)</button>
            <button onclick="generateStitch()">生成长拼图并下载</button>
        </div>

        <div class="control-group">
            <label>5. 存入保险箱</label>
            <input type="text" id="archiveName" placeholder="给当前拼图起个名...">
            <button class="secondary" style="border-color:#333; color:#333;" onclick="saveToArchive()">保存到本地存档</button>
            <p style="font-size:10px; color:#888; margin-top:5px;">* 图片将存入浏览器数据库，即使删除手机相册原图也可查看。</p>
        </div>
    </div>

    <!-- 存档面板 -->
    <div id="tab-archive" class="sidebar-content">
        <div class="control-group">
            <input type="text" id="archiveSearch" placeholder="搜索存档名或备注..." oninput="loadArchiveList()">
        </div>
        <div id="archiveList" style="flex:1; overflow-y:auto;">
            <!-- 存档列表 -->
        </div>
        <button class="danger" onclick="clearAllArchives()">清空所有存档 (慎用)</button>
    </div>
</div>

<div class="main-area">
    <div id="preview-container"></div>
</div>

<script>
    // === 核心数据结构 ===
    let currentImages = []; // 存放 { blob, name, note, id }
    let db; // IndexedDB 实例

    // === 初始化 DB ===
    const request = indexedDB.open("J_Vault_DB", 1);
    request.onupgradeneeded = function(event) {
        db = event.target.result;
        // 创建存档仓库: keyPath为存档ID
        const objectStore = db.createObjectStore("archives", { keyPath: "id", autoIncrement: true });
        objectStore.createIndex("title", "title", { unique: false });
        objectStore.createIndex("notes", "notes", { unique: false }); // 用于搜索备注
    };
    request.onsuccess = function(event) {
        db = event.target.result;
        loadArchiveList(); // 加载存档列表
    };

    // === 界面交互 ===
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.sidebar-content').forEach(c => c.classList.remove('active'));

        if(tab === 'editor') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('tab-editor').classList.add('active');
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('tab-archive').classList.add('active');
            loadArchiveList();
        }
    }

    document.getElementById('ratioSelect').addEventListener('change', function() {
        if(this.value === 'custom') document.getElementById('customRatioBox').style.display = 'flex';
        else document.getElementById('customRatioBox').style.display = 'none';
        renderGallery();
    });

    // === 图片处理 ===
    function handleFiles(files) {
        if(!files.length) return;
        Array.from(files).forEach(file => {
            currentImages.push({
                blob: file, // 原始文件数据
                name: file.name,
                note: "", // 备注
                tempId: Date.now() + Math.random() // 临时ID
            });
        });
        document.getElementById('fileInput').value = ''; // 清空
        renderGallery();
    }

    function renderGallery() {
        const container = document.getElementById('preview-container');
        const cols = document.getElementById('colsInput').value || 3;
        const showNum = document.getElementById('showNumbers').checked;

        // 计算Grid
        container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

        // 计算比例CSS
        let ratio = "1/1";
        const rVal = document.getElementById('ratioSelect').value;
        if(rVal === 'custom') {
            ratio = `${document.getElementById('cW').value}/${document.getElementById('cH').value}`;
        } else {
            ratio = rVal;
        }

        container.innerHTML = '';
        document.getElementById('imgCount').innerText = currentImages.length;

        currentImages.forEach((imgObj, index) => {
            const url = URL.createObjectURL(imgObj.blob);
            const div = document.createElement('div');
            div.className = 'img-card';
            div.style.aspectRatio = ratio;

            div.innerHTML = `
                <img src="${url}">
                ${showNum ? `<div class="badge">${index+1}</div>` : ''}
                <div class="card-back">
                    <textarea placeholder="输入私密备注/关键词...">${imgObj.note}</textarea>
                </div>
                <div class="flip-btn" onclick="toggleFlip(this)">↻</div>
            `;

            // 绑定备注更新
            const ta = div.querySelector('textarea');
            ta.addEventListener('input', (e) => {
                imgObj.note = e.target.value;
            });

            container.appendChild(div);
        });
    }

    window.toggleFlip = function(btn) {
        const card = btn.parentElement;
        card.classList.toggle('flipped');
    }

    // === 存档系统 (IndexedDB) ===
    function saveToArchive() {
        if(currentImages.length === 0) return alert("画布是空的");
        const title = document.getElementById('archiveName').value || ("未命名存档_" + new Date().toLocaleString());

        // 收集所有备注用于搜索
        const allNotes = currentImages.map(i => i.note).join(" ");

        const transaction = db.transaction(["archives"], "readwrite");
        const store = transaction.objectStore("archives");

        const archiveData = {
            title: title,
            date: new Date().getTime(),
            images: currentImages, // 直接存储 Blob 数组
            notesIndex: allNotes
        };

        store.add(archiveData);
        alert(`存档 "${title}" 已存入保险箱。\n你可以安全删除手机里的原图了。`);
    }

    function loadArchiveList() {
        const listDiv = document.getElementById('archiveList');
        const search = document.getElementById('archiveSearch').value.toLowerCase();
        listDiv.innerHTML = '加载中...';

        const transaction = db.transaction(["archives"], "readonly");
        const store = transaction.objectStore("archives");
        const request = store.getAll();

        request.onsuccess = function(event) {
            const archives = event.target.result;
            listDiv.innerHTML = '';

            // 倒序排列 (最新的在上面)
            archives.reverse().forEach(arc => {
                // 搜索过滤
                const matchTitle = arc.title.toLowerCase().includes(search);
                const matchNote = arc.notesIndex && arc.notesIndex.toLowerCase().includes(search);

                if(search && !matchTitle && !matchNote) return;

                const div = document.createElement('div');
                div.className = 'archive-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600">${arc.title}</div>
                        <div class="archive-meta">${new Date(arc.date).toLocaleString()} | ${arc.images.length}张</div>
                    </div>
                    <button class="secondary" style="width:auto; padding:5px 10px;" onclick="loadArchive(${arc.id})">读取</button>
                    <button class="danger" style="width:auto; padding:5px; margin-left:5px;" onclick="deleteArchive(${arc.id})">×</button>
                `;
                listDiv.appendChild(div);
            });

            if(listDiv.innerHTML === '') listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999">暂无存档</div>';
        };
    }

    window.loadArchive = function(id) {
        const transaction = db.transaction(["archives"], "readonly");
        const store = transaction.objectStore("archives");
        const req = store.get(id);
        req.onsuccess = function(e) {
            const data = e.target.result;
            if(confirm(`确定载入存档 "${data.title}" 吗？当前画布将被覆盖。`)) {
                currentImages = data.images;
                document.getElementById('archiveName').value = data.title;
                switchTab('editor');
                renderGallery();
            }
        };
    }

    window.deleteArchive = function(id) {
        if(!confirm("确定销毁此存档记录？不可恢复。")) return;
        const transaction = db.transaction(["archives"], "readwrite");
        const store = transaction.objectStore("archives");
        store.delete(id);
        loadArchiveList(); // 刷新
    }

    window.clearAllArchives = function() {
        if(confirm("警告：这将清空所有本地保存的图片存档！确定吗？")) {
             const transaction = db.transaction(["archives"], "readwrite");
             transaction.objectStore("archives").clear();
             loadArchiveList();
        }
    }

    // === 导出与水印处理 ===
    function downloadLink(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        // 强制重命名为 bengdai
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // 1. 下载指定序号单图
    window.downloadSingle = function() {
        const input = document.getElementById('targetIndex').value;
        if(!input) return alert("请输入序号，例如 1");

        const indexes = input.split(/[,， ]+/).map(s => parseInt(s.trim()) - 1).filter(n => !isNaN(n) && n >= 0 && n < currentImages.length);

        if(indexes.length === 0) return alert("没有找到对应的图片");

        indexes.forEach(idx => {
            const imgObj = currentImages[idx];
            const url = URL.createObjectURL(imgObj.blob);
            // 伪装文件名: bengdai_时间戳_序号
            const safeName = `bengdai_${Date.now()}_img${idx+1}.png`;
            downloadLink(url, safeName);
        });
    }

    // 2. 生成拼图 + 水印
    window.generateStitch = async function() {
        if(currentImages.length === 0) return;
        const btn = document.querySelector('button[onclick="generateStitch()"]');
        const oldText = btn.innerText;
        btn.innerText = "渲染中...";
        btn.disabled = true;

        // 获取参数
        const cols = parseInt(document.getElementById('colsInput').value);
        const ratioSelect = document.getElementById('ratioSelect');
        const showNum = document.getElementById('showNumbers').checked;
        const watermarkOn = document.getElementById('showWatermark').checked;
        const wmOpacity = document.getElementById('wmOpacity').value / 100;

        // 计算尺寸基准 (即便手机端也尽量高清)
        const baseWidth = 1500;
        let whRatio = 1;

        if(ratioSelect.value === 'custom') {
            whRatio = document.getElementById('cW').value / document.getElementById('cH').value;
        } else {
            const p = ratioSelect.value.split('/');
            whRatio = p[0]/p[1];
        }

        const cellHeight = baseWidth / whRatio;
        const rows = Math.ceil(currentImages.length / cols);

        const canvas = document.createElement('canvas');
        canvas.width = cols * baseWidth;
        canvas.height = rows * cellHeight;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = "#fff";
        ctx.fillRect(0,0, canvas.width, canvas.height);

        // 绘制图片循环
        for(let i=0; i<currentImages.length; i++) {
            const imgObj = currentImages[i];
            const img = new Image();
            img.src = URL.createObjectURL(imgObj.blob);
            await new Promise(r => img.onload = r);

            const col = i % cols;
            const row = Math.floor(i / cols);
            const x = col * baseWidth;
            const y = row * cellHeight;

            // 裁剪绘制 (Object-fit: cover)
            const iRatio = img.naturalWidth / img.naturalHeight;
            const tRatio = whRatio;
            let sx, sy, sw, sh;

            if(iRatio > tRatio) {
                sh = img.naturalHeight;
                sw = sh * tRatio;
                sx = (img.naturalWidth - sw)/2;
                sy = 0;
            } else {
                sw = img.naturalWidth;
                sh = sw / tRatio;
                sx = 0;
                sy = (img.naturalHeight - sh)/2;
            }

            ctx.drawImage(img, sx, sy, sw, sh, x, y, baseWidth, cellHeight);

            // 绘制大序号
            if(showNum) {
                const fontSize = 200; // 巨大
                ctx.fillStyle = "rgba(255,255,255,0.9)";
                // 左上角背景块
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + fontSize*1.2, y);
                ctx.lineTo(x + fontSize*1.2, y + fontSize*1.2);
                ctx.arc(x + fontSize*1.2 - 20, y + fontSize*1.2 - 20, 20, 0, Math.PI/2); // 小圆角
                ctx.lineTo(x, y + fontSize*1.2);
                ctx.fill();

                ctx.fillStyle = "#000";
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textBaseline = "top";
                ctx.fillText(i+1, x + 20, y + 20);
            }
        }

        // 绘制全屏水印 (斜线)
        if(watermarkOn) {
            ctx.save();
            ctx.strokeStyle = `rgba(0, 0, 0, ${wmOpacity})`;
            ctx.lineWidth = 2;
            const step = 30; // 密度
            const maxDim = Math.max(canvas.width, canvas.height);

            ctx.beginPath();
            // 斜线算法 \ 方向
            for (let i = -maxDim; i < maxDim * 2; i += step) {
                ctx.moveTo(i, 0);
                ctx.lineTo(i + maxDim, maxDim);
            }
            ctx.stroke();
            ctx.restore();
        }

        // 导出
        const safeName = `bengdai_stitch_${Date.now()}.png`;
        downloadLink(canvas.toDataURL("image/png", 0.9), safeName);

        btn.innerText = oldText;
        btn.disabled = false;
    }
</script>

</body>
</html>
