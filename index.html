<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J's Studio | Nova Final</title>
    <style>
        :root {
            --bg-color: #fafafa;
            --sidebar-width: 340px;
            --accent-black: #111;
            --border: #e0e0e0;
            --danger: #ff4757;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-color);
            color: #333;
        }

        /* 侧边栏 */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 15px rgba(0,0,0,0.02);
            z-index: 10;
        }

        .tabs { display: flex; border-bottom: 1px solid var(--border); background: #f4f4f4; }
        .tab-btn {
            flex: 1; padding: 14px; text-align: center; cursor: pointer;
            font-size: 13px; font-weight: 600; color: #666; transition: 0.2s;
        }
        .tab-btn.active { background: #fff; color: #000; border-bottom: 2px solid #000; }

        .panel { display: none; flex: 1; flex-direction: column; padding: 20px; overflow-y: auto; }
        .panel.active { display: flex; }

        /* 控件 */
        .group { margin-bottom: 18px; border-bottom: 1px solid #f0f0f0; padding-bottom: 18px; }
        .group:last-child { border: none; }
        label { display: block; font-size: 12px; font-weight: 700; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

        button {
            width: 100%; padding: 10px; border: none; background: var(--accent-black);
            color: #fff; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 4px;
            transition: opacity 0.2s; margin-top: 5px;
        }
        button:hover { opacity: 0.85; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.sec { background: #fff; color: #000; border: 1px solid #ddd; }
        button.danger { background: var(--danger); color: white; }

        input[type="text"], input[type="number"], select {
            width: 100%; padding: 8px; font-size: 13px;
            border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
            background: #fff; margin-bottom: 5px;
        }
        input:focus { border-color: #000; outline: none; }

        /* 画布区 */
        .canvas-area {
            flex: 1; background: #e5e5e5; display: flex;
            justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 40px;
        }

        #grid {
            background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: grid; width: 100%; max-width: 1000px;
        }

        .card { position: relative; background: #ddd; overflow: hidden; aspect-ratio: 1; transition: transform 0.2s; }
        .card img { width: 100%; height: 100%; object-fit: cover; display: block; }

        /* 翻转背面 - 备注 */
        .card-back {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; padding: 10px; box-sizing: border-box;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .card.flipped .card-back { transform: translateY(0); }
        textarea {
            width: 100%; height: 100%; background: transparent; border: none;
            color: #eee; resize: none; outline: none; font-size: 12px; line-height: 1.5;
        }

        /* 控件UI细节 */
        .badge {
            position: absolute; top:0; left:0;
            background: rgba(255,255,255,0.95); color: #000;
            font-size: 24px; font-weight: 800; padding: 4px 12px;
            border-bottom-right-radius: 12px; z-index: 5; pointer-events: none;
        }
        .flip-toggle {
            position: absolute; bottom: 8px; right: 8px;
            width: 24px; height: 24px; background: rgba(0,0,0,0.6);
            color: #fff; border-radius: 50%; text-align: center;
            line-height: 24px; cursor: pointer; z-index: 6; font-size: 10px;
        }

        /* 存档列表 */
        .archive-item {
            background: #f8f8f8; padding: 12px; border-radius: 4px;
            margin-bottom: 8px; border: 1px solid #eee; display: flex;
            justify-content: space-between; align-items: center;
        }
        .archive-item:hover { background: #fff; border-color: #ccc; }
        .archive-info h4 { margin: 0 0 4px 0; font-size: 13px; font-weight: 600; }
        .archive-info p { margin: 0; font-size: 11px; color: #888; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="tabs">
        <div class="tab-btn active" onclick="setTab('make')">拼图制作</div>
        <div class="tab-btn" onclick="setTab('storage')">本地存档库</div>
    </div>

    <!-- 制作面板 -->
    <div id="panel-make" class="panel active">
        <div class="group">
            <label>1. 资源 (当前: <span id="count">0</span>P)</label>
            <input type="file" id="fileIn" multiple accept="image/*" style="display:none" onchange="addFiles(this.files)">
            <button onclick="document.getElementById('fileIn').click()">+ 添加图片</button>
            <button class="sec" onclick="clearCanvas()">清空画布</button>
        </div>

        <div class="group">
            <label>2. 布局 & 比例</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="number" id="cols" value="3" min="1" onchange="render()" placeholder="列数" style="flex:1">
                <input type="number" id="gap" value="0" min="0" onchange="render()" placeholder="间距" style="flex:1">
            </div>
            <select id="ratio" onchange="render()">
                <option value="1/1">1 : 1</option>
                <option value="3/4">3 : 4</option>
                <option value="4/3">4 : 3</option>
                <option value="9/16">9 : 16</option>
                <option value="16/9">16 : 9</option>
                <option value="2/3">2 : 3</option>
                <option value="3/2">3 : 2</option>
                <option value="7/5">7 : 5</option>
                <option value="5/7">5 : 7</option>
            </select>
        </div>

        <div class="group">
            <label>3. 序号 & 水印</label>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                <input type="checkbox" id="chkNum" checked onchange="render()" style="width:auto">
                <span style="font-size:13px">显示大序号</span>
            </div>

            <label style="font-weight:400; font-size:11px;">防盗斜纹 (透明度 %)</label>
            <div style="display:flex; gap:5px;">
                <input type="range" id="wmAlpha" min="0" max="100" value="0" style="flex:1">
                <span id="wmVal" style="font-size:12px; width:30px;">0</span>
            </div>
        </div>

        <div class="group">
            <label>4. 导出 (bengdai_xxxx.png)</label>
            <button onclick="exportStitch()">保存拼图 (优化防卡顿)</button>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="dlIdx" placeholder="输入序号 例如 1 3 5" style="flex:2">
                <button class="sec" onclick="dlSingle()" style="flex:1; margin-top:0">下原图</button>
            </div>
        </div>

        <div class="group" style="border:none">
            <label>5. 存档</label>
            <input type="text" id="arcName" placeholder="为当前拼图命名...">
            <button class="sec" onclick="saveArchive()">保存到保险箱</button>
        </div>
    </div>

    <!-- 存档面板 -->
    <div id="panel-storage" class="panel">
        <input type="text" id="search" placeholder="搜索存档名或图片备注..." oninput="loadList()">
        <div id="list" style="flex:1; margin-top:10px;"></div>
        <button class="danger" onclick="nukeDB()">⚠ 清空所有数据</button>
    </div>
</div>

<div class="canvas-area">
    <div id="grid"></div>
</div>

<script>
    // --- 核心逻辑 ---
    let images = []; // {blob, name, note}
    let db;

    // 初始化数据库
    const dbReq = indexedDB.open("NovaPuzzleDB", 2);
    dbReq.onupgradeneeded = e => {
        const d = e.target.result;
        if(!d.objectStoreNames.contains("vault")) {
            const store = d.createObjectStore("vault", {keyPath: "id", autoIncrement:true});
        }
    };
    dbReq.onsuccess = e => { db = e.target.result; loadList(); };

    // DOM 元素引用
    const UI = {
        grid: document.getElementById('grid'),
        fileIn: document.getElementById('fileIn'),
        count: document.getElementById('count'),
        wmAlpha: document.getElementById('wmAlpha'),
        wmVal: document.getElementById('wmVal')
    };

    // 事件监听
    UI.wmAlpha.oninput = () => UI.wmVal.innerText = UI.wmAlpha.value;

    function setTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        if(t==='make') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('panel-make').classList.add('active');
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('panel-storage').classList.add('active');
            loadList();
        }
    }

    function addFiles(fl) {
        if(!fl.length) return;
        Array.from(fl).forEach(f => {
            images.push({ blob: f, name: f.name, note: "" });
        });
        UI.fileIn.value = '';
        render();
    }

    function clearCanvas() {
        if(confirm("清空当前画布？")) { images = []; render(); }
    }

    function render() {
        UI.count.innerText = images.length;
        const cols = document.getElementById('cols').value || 3;
        const gap = document.getElementById('gap').value || 0;
        const rStr = document.getElementById('ratio').value;
        const rArr = rStr.split('/');
        const ratio = rArr[0]/rArr[1];
        const showNum = document.getElementById('chkNum').checked;

        UI.grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        UI.grid.style.gap = `${gap}px`;
        UI.grid.innerHTML = '';

        images.forEach((img, i) => {
            const div = document.createElement('div');
            div.className = 'card';
            // CSS aspect-ratio
            div.style.aspectRatio = `${rArr[0]} / ${rArr[1]}`;

            const u = URL.createObjectURL(img.blob);
            div.innerHTML = `
                <img src="${u}">
                ${showNum ? `<div class="badge">${i+1}</div>` : ''}
                <div class="card-back">
                    <textarea placeholder="输入备注...">${img.note}</textarea>
                </div>
                <div class="flip-toggle" onclick="this.parentElement.classList.toggle('flipped')">↻</div>
            `;

            div.querySelector('textarea').oninput = (e) => img.note = e.target.value;
            UI.grid.appendChild(div);
        });
    }

    // --- 导出逻辑 (防卡顿核心) ---
    async function exportStitch() {
        if(!images.length) return;
        const btn = document.querySelector('button[onclick="exportStitch()"]');
        btn.innerText = "正在渲染..."; btn.disabled = true;

        try {
            // 参数获取
            const cols = parseInt(document.getElementById('cols').value);
            const gap = parseInt(document.getElementById('gap').value);
            const rStr = document.getElementById('ratio').value.split('/');
            const ratio = rStr[0] / rStr[1];
            const rows = Math.ceil(images.length / cols);
            const showNum = document.getElementById('chkNum').checked;
            const wmOp = parseInt(document.getElementById('wmAlpha').value) / 100;

            // 智能计算尺寸：限制总像素在 5000万以内防止崩溃 (Chrome限制约1.6亿，保守一点)
            // 基准：假设每张小图最宽 1200px
            let cellW = 1200;
            let totalW = (cols * cellW) + ((cols-1)*gap);
            let totalH = (rows * (cellW/ratio)) + ((rows-1)*gap);

            // 如果总面积太大，进行缩放
            const limit = 5000 * 5000; // 25MP 安全线
            if(totalW * totalH > limit) {
                const scale = Math.sqrt(limit / (totalW * totalH));
                cellW = Math.floor(cellW * scale);
                // 重新计算
                totalW = (cols * cellW) + ((cols-1)*gap);
                totalH = (rows * (cellW/ratio)) + ((rows-1)*gap);
            }

            const cellH = cellW / ratio;

            const cvs = document.createElement('canvas');
            cvs.width = totalW;
            cvs.height = totalH;
            const ctx = cvs.getContext('2d');

            ctx.fillStyle = "#fff";
            ctx.fillRect(0,0, totalW, totalH);

            // 绘制
            for(let i=0; i<images.length; i++) {
                const imgInfo = images[i];
                const img = new Image();
                img.src = URL.createObjectURL(imgInfo.blob);
                await new Promise(r => img.onload = r);

                const c = i % cols;
                const r = Math.floor(i / cols);
                const x = c * (cellW + gap);
                const y = r * (cellH + gap);

                // 保持比例裁剪 (Cover)
                let sx, sy, sw, sh;
                const ir = img.naturalWidth / img.naturalHeight;
                if(ir > ratio) {
                    sh = img.naturalHeight; sw = sh * ratio;
                    sx = (img.naturalWidth - sw)/2; sy = 0;
                } else {
                    sw = img.naturalWidth; sh = sw / ratio;
                    sx = 0; sy = (img.naturalHeight - sh)/2;
                }

                ctx.drawImage(img, sx, sy, sw, sh, x, y, cellW, cellH);

                // 绘制序号
                if(showNum) {
                    const fs = Math.max(20, cellW * 0.15); // 自适应字号
                    ctx.save();
                    ctx.fillStyle = "rgba(255,255,255,0.9)";
                    ctx.beginPath();
                    ctx.moveTo(x,y);
                    ctx.lineTo(x + fs*1.5, y);
                    ctx.lineTo(x + fs*1.5, y + fs*1.2);
                    ctx.arc(x + fs*1.5 - (fs/2), y + fs*1.2 - (fs/2), fs/2, 0, Math.PI/2);
                    ctx.lineTo(x, y + fs*1.2);
                    ctx.fill();

                    ctx.fillStyle = "#000";
                    ctx.font = `800 ${fs}px Arial`;
                    ctx.textBaseline = "top";
                    ctx.fillText(i+1, x + (fs*0.2), y + (fs*0.1));
                    ctx.restore();
                }
            }

            // 绘制水印 (高效版：使用 Pattern)
            if(wmOp > 0) {
                const pCvs = document.createElement('canvas');
                pCvs.width = 100; pCvs.height = 100;
                const pCtx = pCvs.getContext('2d');
                pCtx.strokeStyle = `rgba(0,0,0,${wmOp})`;
                pCtx.lineWidth = 2;
                pCtx.beginPath();
                pCtx.moveTo(0,0); pCtx.lineTo(100,100); // \
                pCtx.stroke();

                const ptrn = ctx.createPattern(pCvs, 'repeat');
                ctx.fillStyle = ptrn;
                ctx.fillRect(0,0, totalW, totalH);
            }

            // 导出 blob (关键防卡顿步骤)
            cvs.toBlob(blob => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `bengdai_stitch_${Date.now()}.png`;
                a.click();
                btn.innerText = "保存拼图";
                btn.disabled = false;
            }, 'image/png', 0.9);

        } catch(e) {
            console.error(e);
            alert("生成失败，可能是内存不足，请尝试减少图片数量");
            btn.innerText = "保存拼图";
            btn.disabled = false;
        }
    }

    function dlSingle() {
        const txt = document.getElementById('dlIdx').value;
        if(!txt) return;
        const arr = txt.split(/[\s,]+/).map(n => parseInt(n)-1);
        arr.forEach(idx => {
            if(images[idx]) {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(images[idx].blob);
                a.download = `bengdai_img_${idx+1}_${Date.now()}.png`;
                a.click();
            }
        });
    }

    // --- 存档逻辑 ---
    function saveArchive() {
        if(!images.length) return alert("空的");
        const name = document.getElementById('arcName').value || ("存档_" + new Date().toLocaleTimeString());

        // 构建搜索索引文字
        const noteText = images.map(m => m.note).join("##");

        const tx = db.transaction("vault", "readwrite");
        tx.objectStore("vault").add({
            title: name,
            time: Date.now(),
            imgs: images, // 存储 blob
            keywords: noteText
        });
        tx.oncomplete = () => { alert("已存入本地保险箱"); loadList(); };
    }

    function loadList() {
        if(!db) return;
        const q = document.getElementById('search').value.toLowerCase();
        const tx = db.transaction("vault", "readonly");
        const req = tx.objectStore("vault").getAll();

        req.onsuccess = e => {
            const list = document.getElementById('list');
            list.innerHTML = "";
            const arr = e.target.result.reverse();

            arr.forEach(item => {
                // 搜索逻辑：搜标题 OR 搜备注
                const matchK = item.keywords && item.keywords.toLowerCase().includes(q);
                const matchT = item.title.toLowerCase().includes(q);

                if(q && !matchK && !matchT) return;

                const row = document.createElement('div');
                row.className = "archive-item";
                row.innerHTML = `
                    <div class="archive-info" onclick="loadItem(${item.id})" style="flex:1;cursor:pointer">
                        <h4>${item.title}</h4>
                        <p>${new Date(item.time).toLocaleString()} · ${item.imgs.length}张</p>
                    </div>
                    <button class="danger" style="width:30px; margin:0;" onclick="delItem(${item.id})">×</button>
                `;
                list.appendChild(row);
            });
        };
    }

    window.loadItem = function(id) {
        if(images.length > 0 && !confirm("当前画布有图片，是否覆盖？")) return;
        const tx = db.transaction("vault", "readonly");
        tx.objectStore("vault").get(id).onsuccess = e => {
            images = e.target.result.imgs;
            document.getElementById('arcName').value = e.target.result.title;
            render();
            setTab('make');
        };
    };

    window.delItem = function(id) {
        if(confirm("删除此存档？")) {
            const tx = db.transaction("vault", "readwrite");
            tx.objectStore("vault").delete(id).onsuccess = loadList;
        }
    };

    window.nukeDB = function() {
        if(confirm("确定清空所有存档？不可恢复！")) {
            const tx = db.transaction("vault", "readwrite");
            tx.objectStore("vault").clear().onsuccess = loadList;
        }
    };
</script>
</body>
</html>
